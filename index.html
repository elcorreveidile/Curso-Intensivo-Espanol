<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Curso Intensivo de Espa√±ol ‚Äî Nivel 3 CLM (A1.2-A2.1)</title>
  <style>
    :root{
      --fg:#1f2937; --bg:#ffffff; --border:#e5e7eb; --brand:#059669; --card:#ffffff;
      --s1:#fef3c7; --s2:#dbeafe; --s3:#dcfce7; --s4:#fae8ff; --s5:#e0f2fe;
      --primary-color:#059669; --secondary-color:#3b82f6; --muted-color:#6b7280; --border-color:#d1d5db;
    }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial}
    a{color:inherit;text-decoration:none}
    .container{max-width:1100px;margin:0 auto;padding:1rem}
    :target{scroll-margin-top:72px}

    /* NAV */
    .nav{position:sticky;top:0;z-index:20;background:rgba(255,255,255,.96);backdrop-filter:saturate(180%) blur(10px);border-bottom:1px solid var(--border)}
    .nav .inner{display:flex;gap:.5rem;align-items:center}
    .brand{font-weight:800;display:flex;align-items:center;gap:.75rem}
    .brand .logo{height:40px;width:auto;object-fit:contain}
    .spacer{flex:1}
    .links{display:flex;gap:.5rem;align-items:center}
    .links a{display:inline-block;padding:.5rem .75rem;border:1px solid var(--border);border-radius:9999px;background:#fff;white-space:nowrap}
    .hamb{display:none;appearance:none;border:1px solid var(--border);background:#fff;border-radius:.75rem;padding:.5rem .6rem}
    .mobile-panel{display:none;position:fixed;top:56px;left:0;right:0;background:#fff;border-bottom:1px solid var(--border);box-shadow:0 6px 20px rgba(0,0,0,.06)}
    .mobile-panel .row{display:flex;overflow-x:auto;gap:.5rem;padding:.75rem 1rem}
    .mobile-panel a{display:inline-block;padding:.5rem .75rem;border:1px solid var(--border);border-radius:9999px;background:#fff;white-space:nowrap}

    /* Layout */
    .section{padding:3rem 0;position:relative;overflow:hidden}
    .section > .container{position:relative;z-index:1}
    /* Fondo con colores s√≥lidos */
    #s1{background:var(--s1)}
    #s2{background:var(--s2)}
    #s3{background:var(--s3)}
    #s4{background:var(--s4)}
    #s5{background:var(--s5)}

    h1{font-size:clamp(1.8rem,2.5vw,3rem);margin:.3rem 0}
    h2{font-size:clamp(1.5rem,2vw,2.2rem);margin:0 0 .5rem 0}
    h3{margin:.5rem 0}
    .muted{color:#374151;font-size:.95rem}
    .btn{display:inline-block;padding:.6rem 1rem;border-radius:9999px;border:1px solid var(--border);background:#fff;cursor:pointer}
    .btn.primary{background:var(--brand);color:#fff;border-color:var(--brand)}
    .list{padding-left:1.1rem}
    .list li{margin:.35rem 0}
    .footer{border-top:1px solid var(--border);padding:1rem 0;color:#6b7280}
    .card{background:rgba(255,255,255,.92);border:1px solid var(--border);border-radius:1rem;padding:1rem}
    @media(max-width:899px){.card{background:rgba(255,255,255,.96)}}
    .grid{display:grid;gap:1rem}
    @media(min-width:900px){.grid-3{grid-template-columns: 1fr 1fr 1fr;}}
    .chip{display:inline-block;padding:.25rem .6rem;border:1px solid var(--border);border-radius:9999px;margin:.15rem .25rem;background:#fff;cursor:pointer}
    .chip.active{background:#059669;color:#fff;border-color:#059669}
    .hint{font-size:.9rem;color:#334155;margin:.25rem 0 .5rem}

    table{width:100%;border-collapse:collapse}
    th,td{border:1px solid var(--border);padding:.6rem;text-align:left}
    th{background:#f8fafc}

    @media (max-width:899px){
      .links{display:none}
      .hamb{display:inline-block}
      .container{padding:.75rem 1rem}
      .section{padding:2rem 0}
      .grid-3{grid-template-columns:1fr 1fr}
    }
    @media (max-width:480px){
      .grid-3{grid-template-columns:1fr}
      .brand{font-size:0.9rem}
      .brand .logo{height:32px}
    }
    .nav.open .mobile-panel{display:block}

    /* Smooth animations */
    .card, .btn, .chip {
      transition: all 0.3s ease;
    }
    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    }
    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .chip:hover {
      transform: translateY(-1px);
    }

    /* Loading animation */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .section {
      animation: fadeIn 0.6s ease-out;
    }

    /* Visor PDF */
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;z-index:50}
    .overlay.show{display:block}
    .viewer{position:fixed;inset:5% 3%;background:#111827;border-radius:1rem;box-shadow:0 25px 50px rgba(0,0,0,.35);display:none;flex-direction:column;z-index:60}
    .viewer .top{display:flex;align-items:center;gap:.5rem;padding:.6rem .75rem;background:#0f172a;color:#fff;border-top-left-radius:1rem;border-top-right-radius:1rem;flex-wrap:wrap}
    .viewer .top .spacer{flex:1}
    .viewer .btn{border-color:#334155;background:#fff;color:#0f172a;font-weight:600;padding:.45rem .8rem;border-radius:.65rem;text-decoration:none;display:inline-flex;align-items:center;gap:.4rem}
    .viewer iframe{flex:1;border:0;border-bottom-left-radius:1rem;border-bottom-right-radius:1rem;background:#fff}
    .viewer .content{flex:1;border-bottom-left-radius:1rem;border-bottom-right-radius:1rem;background:#fff;padding:2rem;overflow-y:auto;font-family:Georgia, serif;line-height:1.6;color:#1f2937}
    .viewer .content pre{white-space:pre-wrap;font-family:inherit;margin:0}
    .viewer .content h1{font-size:1.8rem;color:#111827;margin-bottom:1rem;border-bottom:2px solid #e5e7eb;padding-bottom:0.5rem}
    .viewer .content h2{font-size:1.4rem;color:#374151;margin-top:1.5rem;margin-bottom:0.75rem}
    .viewer .content h3{font-size:1.2rem;color:#4b5563;margin-top:1rem;margin-bottom:0.5rem}
    .viewer .content ul{margin:0.5rem 0;padding-left:1.5rem}
    .viewer .content li{margin:0.3rem 0}
    .viewer .content strong{color:#111827}
    @media (max-width:640px){ .viewer{inset:4% 2%} .viewer .btn{flex:1;justify-content:center;min-width:120px} #fileName{flex-basis:100%;font-size:1rem} .viewer .content{padding:1rem} }

    /* Enhanced styles for the course */
    .highlight-box {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      border: 2px solid #f59e0b;
      border-radius: 1rem;
      padding: 1.5rem;
      margin: 1rem 0;
      box-shadow: 0 8px 25px rgba(245, 158, 11, 0.25);
      position: relative;
      overflow: hidden;
    }
    .highlight-box::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      transition: left 0.6s;
    }
    .highlight-box:hover::before {
      left: 100%;
    }
    .highlight-box h3 {
      color: #92400e;
      margin-top: 0;
    }
    .schedule-card {
      background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
      border: 2px solid #3b82f6;
      border-radius: 1rem;
      padding: 1.2rem;
      margin: 0.5rem 0;
    }
    .time-badge {
      display: inline-block;
      background: #059669;
      color: white;
      padding: 0.3rem 0.8rem;
      border-radius: 9999px;
      font-weight: 600;
      font-size: 0.9rem;
      margin: 0.2rem 0.2rem 0.2rem 0;
    }

    /* Progress tracking styles */
    .progress-container {
      background: rgba(255,255,255,0.9);
      border-radius: 1rem;
      padding: 1rem;
      margin: 1rem 0;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    .progress-bar {
      width: 100%;
      height: 20px;
      background: #e5e7eb;
      border-radius: 9999px;
      overflow: hidden;
      margin: 0.5rem 0;
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #059669, #10b981);
      border-radius: 9999px;
      transition: width 0.5s ease;
      position: relative;
    }
    .progress-fill::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      animation: shimmer 2s infinite;
    }
    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }

    /* Interactive vocabulary cards */
    .vocab-card {
      background: white;
      border: 2px solid #e5e7eb;
      border-radius: 0.75rem;
      padding: 1rem;
      margin: 0.5rem 0;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
    }
    .vocab-card:hover {
      border-color: #059669;
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(5,150,105,0.15);
    }
    .vocab-card .translation {
      display: none;
      color: #059669;
      font-weight: 600;
      margin-top: 0.5rem;
    }
    .vocab-card.revealed .translation {
      display: block;
    }

    /* Quiz styles */
    .quiz-option {
      background: white;
      border: 2px solid #e5e7eb;
      border-radius: 0.5rem;
      padding: 1rem;
      margin: 0.5rem 0;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .quiz-option:hover {
      border-color: #3b82f6;
      background: #f0f9ff;
    }
    .quiz-option.selected {
      border-color: #3b82f6;
      background: #dbeafe;
    }
    .quiz-option.correct {
      border-color: #059669;
      background: #dcfce7;
    }
    .quiz-option.incorrect {
      border-color: #ef4444;
      background: #fee2e2;
    }

    /* Floating action button */
    .fab {
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      width: 60px;
      height: 60px;
      background: linear-gradient(135deg, #059669, #10b981);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 1.5rem;
      cursor: pointer;
      box-shadow: 0 8px 25px rgba(5,150,105,0.3);
      transition: all 0.3s ease;
      z-index: 15;
    }
    .fab:hover {
      transform: translateY(-2px) scale(1.1);
      box-shadow: 0 12px 35px rgba(5,150,105,0.4);
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body>
  <!-- NAV -->
  <div class="nav" id="nav">
    <div class="container inner">
      <div class="brand">
        <img src="images/Logo-CLM-V1.jpg" alt="Logo CLM" class="logo">
        üá™üá∏ Curso Intensivo de Espa√±ol ‚Äî Nivel 3 CLM
      </div>
      <div class="spacer"></div>
      <div class="links" aria-label="Men√∫ principal">
        <a href="#s1">Gu√≠a</a>
        <a href="#s2">Competencias</a>
        <a href="#s3">Temario</a>
        <a href="#s4">Proyectos</a>
        <a href="#s5">Evaluaci√≥n</a>
        <a href="#descargas">Descargas</a>
        <a href="#foro">Foro</a>
        <a href="#taller">Taller</a>
      </div>
      <button class="hamb" id="hamb" aria-label="Abrir men√∫">‚ò∞</button>
    </div>
    <div class="mobile-panel" id="mobilePanel">
      <div class="row">
        <a href="#s1">Gu√≠a</a>
        <a href="#s2">Competencias</a>
        <a href="#s3">Temario</a>
        <a href="#s4">Proyectos</a>
        <a href="#s5">Evaluaci√≥n</a>
        <a href="#descargas">Descargas</a>
        <a href="#foro">Foro</a>
        <a href="#taller">Taller</a>
      </div>
    </div>
  </div>

  <!-- SECCI√ìN 1: GU√çA -->
  <section class="section" id="s1">
    <div class="container">
      <div id="current-date" style="text-align: center; font-size: 1.2rem; font-weight: 600; color: var(--primary-color); margin-bottom: 1rem;"></div>
      <h2>üìò Gu√≠a del curso</h2>

      <div class="highlight-box">
        <h3>üåç ¬°Bienvenidos al Curso Intensivo de Espa√±ol!</h3>
        <p><strong>Nivel 3 CLM (A1.2-A2.1)</strong> - Un curso dise√±ado especialmente para estudiantes americanos y asi√°ticos que quieren mejorar r√°pidamente su espa√±ol en un ambiente inmersivo y din√°mico.</p>
        <p><strong>üìÖ Fechas:</strong> 6 al 27 de noviembre de 2025</p>
        <p><strong>üë• Grupo reducido:</strong> 9-10 estudiantes para atenci√≥n personalizada</p>
      </div>

      <div class="grid grid-3">
        <div class="card">
          <h3>Datos clave</h3>
          <div id="qr-attendance" style="text-align: center; margin: 15px 0;">
            <h4 style="color: var(--primary-color); margin-bottom: 10px;">üì± Asistencia del D√≠a</h4>
            <div id="qr-code-container" style="background: white; padding: 15px; border-radius: 8px; display: inline-block; border: 2px solid var(--border-color);">
              <div id="qr-code"></div>
            </div>
            <div id="qr-timer" style="margin-top: 10px; font-weight: 600; color: var(--secondary-color);"></div>
            <p style="font-size: 0.9rem; color: var(--muted-color); margin-top: 10px;">
              Escanear con el m√≥vil para registrar asistencia
            </p>
            <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; margin-top: 10px;">
              <button id="generate-new-qr" style="padding: 8px 16px; background: var(--secondary-color); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">
                Generar Nuevo C√≥digo
              </button>
              <button id="open-pdf-generator" style="padding: 8px 16px; background: #059669; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem;" onclick="window.open('attendance-pdf.html', '_blank')">
                üìÑ Generar Hoja de Asistencia
              </button>
              </div>
          </div>
          <ul class="list">
            <li>2025/2026</li>
            <li><strong>6 ‚Äì 27 noviembre 2025</strong></li>
            <li>Curso intensivo ¬∑ 24 horas (17 sesiones)</li>
            <li><strong>Profesor:</strong> Javier Ben√≠tez L√°inez</li>
            <li><strong>Aula:</strong> 24</li>
            <li><strong>Nivel:</strong> 3 CLM (A1.2-A2.1)</li>
            <li><strong>Requisitos:</strong> Nivel b√°sico de espa√±ol</li>
          </ul>
        </div>

        <div class="card">
          <h3>üìÖ Horario del curso</h3>
          <div class="schedule-card">
            <h4>De lunes a jueves</h4>
            <div class="time-badge">8:30 - 10:30</div>
            <p>2 horas de clase intensiva diaria</p>
          </div>
          <p><strong>Total: 8 horas semanales</strong> con enfoque en comunicaci√≥n pr√°ctica</p>
          <h3 style="margin-top:.75rem">Objetivo general</h3>
          <p>Desarrollar las competencias comunicativas b√°sicas en espa√±ol para alcanzar un nivel A2.1, enfoc√°ndose en la comunicaci√≥n pr√°ctica para situaciones cotidianas y acad√©micas.</p>
        </div>

        <div class="card">
          <h3>Gu√≠as de la sesi√≥n</h3>
          <p class="hint">Pulsa la sesi√≥n para abrir su gu√≠a (PDF).</p>
          <div id="chips-s1"></div>
          <ul class="list" id="lista-s1"></ul>
        </div>

        <div class="card">
          <h3>üìö Materiales del Curso</h3>
          <p class="hint">Pulsa un material para ver sus opciones de descarga y visualizaci√≥n.</p>
          <div id="chips-materials" style="display: flex; flex-wrap: wrap; gap: 8px; margin: 12px 0;"></div>
          <ul class="list" id="lista-materials"></ul>

          <!-- Hoja de Asistencia - Solo visible para profesor (access URL con ?profesor=1) -->
          <div id="profesor-only" style="margin-top: 16px; padding-top: 12px; border-top: 1px solid #eee; display: none;">
            <p style="font-size: 12px; color: #666; margin: 0 0 8px 0;">üìÑ Hoja de Asistencia (Acceso Profesor):</p>
            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
              <button class="btn" onclick="window.open('materials/hoja-asistencia.pdf', '_blank')" style="font-size: 12px; padding: 4px 8px; background: #ff6b6b;">
                üìã Abrir Hoja de Asistencia
              </button>
              <button class="btn" onclick="downloadPDF('materials/hoja-asistencia.pdf', 'hoja-asistencia.pdf')" style="font-size: 12px; padding: 4px 8px; background: #ff6b6b;">
                ‚¨áÔ∏è Descargar
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- SECCI√ìN DE ACCESO ESTUDIANTES -->
  <section class="section" style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); padding: 2rem 0;">
    <div class="container">
      <div id="loginSection">
        <h2>üë§ Acceso de Estudiantes</h2>
        <p>Inicia sesi√≥n para guardar tu progreso y acceder a material personalizado</p>

        <div class="card" style="max-width: 500px; margin: 0 auto;">
          <div id="loginForm">
            <h3>Iniciar Sesi√≥n</h3>
            <div style="margin: 1rem 0;">
              <label for="studentId" style="display: block; margin-bottom: 0.5rem; font-weight: 600;">ID de Estudiante:</label>
              <input type="text" id="studentId" placeholder="Tu ID √∫nico" style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 0.5rem; margin-bottom: 1rem;">

              <label for="studentPassword" style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Contrase√±a:</label>
              <input type="password" id="studentPassword" placeholder="Tu contrase√±a" style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 0.5rem; margin-bottom: 1rem;">

              <button class="btn primary" style="width: 100%; padding: 0.75rem;" onclick="studentLogin()">Iniciar Sesi√≥n</button>
            </div>

            <div style="text-align: center; margin: 1rem 0;">
              <p>¬øNo tienes cuenta? <a href="#" onclick="showRegisterForm()" style="color: var(--brand); font-weight: 600;">Reg√≠strate aqu√≠</a></p>
            </div>
          </div>

          <div id="registerForm" style="display: none;">
            <h3>Registro de Nuevo Estudiante</h3>
            <div style="margin: 1rem 0;">
              <label for="regName" style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Nombre completo:</label>
              <input type="text" id="regName" placeholder="Tu nombre" style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 0.5rem; margin-bottom: 1rem;">

              <label for="regEmail" style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Email:</label>
              <input type="email" id="regEmail" placeholder="tu@email.com" style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 0.5rem; margin-bottom: 1rem;">

              <label for="regStudentId" style="display: block; margin-bottom: 0.5rem; font-weight: 600;">ID de Estudiante (opcional):</label>
              <input type="text" id="regStudentId" placeholder="Tu ID si ya tienes uno" style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 0.5rem; margin-bottom: 1rem;">

              <button class="btn primary" style="width: 100%; padding: 0.75rem;" onclick="studentRegister()">Registrarse</button>
            </div>

            <div style="text-align: center; margin: 1rem 0;">
              <p>¬øYa tienes cuenta? <a href="#" onclick="showLoginForm()" style="color: var(--brand); font-weight: 600;">Inicia sesi√≥n</a></p>
            </div>
          </div>
        </div>

        <div id="userInfo" style="display: none;">
          <div class="card" style="max-width: 600px; margin: 0 auto; text-align: center;">
            <div style="font-size: 3rem; margin-bottom: 1rem;">üë®‚Äçüéì</div>
            <h3 id="welcomeMessage">¬°Bienvenido!</h3>
            <p id="userDetails">Estudiante del Curso Intensivo de Espa√±ol</p>

            <div style="margin: 2rem 0; padding: 1rem; background: white; border-radius: 0.5rem;">
              <h4>Tu Progreso Personal</h4>
              <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin: 1rem 0;">
                <div>
                  <div style="font-size: 1.5rem; font-weight: bold; color: var(--brand);" id="userAttendanceProgress">0/16</div>
                  <div style="font-size: 0.9rem; color: var(--muted-color);">Clases Asistidas</div>
                </div>
                <div>
                  <div style="font-size: 1.5rem; font-weight: bold; color: var(--secondary-color);" id="userMaterialsProgress">0/8</div>
                  <div style="font-size: 0.9rem; color: var(--muted-color);">Materiales</div>
                </div>
                <div>
                  <div style="font-size: 1.5rem; font-weight: bold; color: #f59e0b;" id="userPointsDisplay">0</div>
                  <div style="font-size: 0.9rem; color: var(--muted-color);">Puntos</div>
                </div>
              </div>
            </div>

            <button class="btn" onclick="studentLogout()">Cerrar Sesi√≥n</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- SECCI√ìN DE PROGRESO (actualizado para usuario logueado) -->
  <section class="section" id="progressSection" style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); padding: 2rem 0; display: none;">
    <div class="container">
      <h2>üìà Tu Progreso en el Curso</h2>

      <div class="progress-container">
        <h3>Progreso General del Curso</h3>
        <div class="progress-bar">
          <div class="progress-fill" id="mainProgress" style="width: 0%;"></div>
        </div>
        <p id="progressText">0% completado - ¬°Comienza tu aprendizaje!</p>

        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 1rem;">
          <div style="text-align: center;">
            <div style="font-size: 2rem; font-weight: bold; color: var(--brand);" id="attendanceProgress">0/12</div>
            <div style="color: var(--muted-color);">Clases Asistidas</div>
          </div>
          <div style="text-align: center;">
            <div style="font-size: 2rem; font-weight: bold; color: var(--secondary-color);" id="materialsProgress">0/8</div>
            <div style="color: var(--muted-color);">Materiales Completados</div>
          </div>
          <div style="text-align: center;">
            <div style="font-size: 2rem; font-weight: bold; color: #f59e0b;" id="projectsProgress">0/3</div>
            <div style="color: var(--muted-color);">Proyectos Entregados</div>
          </div>
          <div style="text-align: center;">
            <div style="font-size: 2rem; font-weight: bold; color: #ef4444;" id="vocabularyProgress">0/50</div>
            <div style="color: var(--muted-color);">Palabras Aprendidas</div>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top: 1rem;">
        <h3>üéØ Objetivos de la Semana</h3>
        <ul class="list" id="weeklyGoals">
          <li>
            <input type="checkbox" id="goal1" onchange="updateWeeklyProgress()">
            <label for="goal1">Completar el M√≥dulo 1: Comunicaci√≥n b√°sica</label>
          </li>
          <li>
            <input type="checkbox" id="goal2" onchange="updateWeeklyProgress()">
            <label for="goal2">Practicar 15 minutos de vocabulario diario</label>
          </li>
          <li>
            <input type="checkbox" id="goal3" onchange="updateWeeklyProgress()">
            <label for="goal3">Participar en la sesi√≥n de conversaci√≥n del jueves</label>
          </li>
          <li>
            <input type="checkbox" id="goal4" onchange="updateWeeklyProgress()">
            <label for="goal4">Entregar el primer proyecto fotogr√°fico</label>
          </li>
        </ul>
        <div class="progress-bar" style="margin-top: 1rem;">
          <div class="progress-fill" id="weeklyProgress" style="width: 0%; background: linear-gradient(90deg, #f59e0b, #fbbf24);"></div>
        </div>
        <p id="weeklyProgressText" style="margin-top: 0.5rem; color: var(--muted-color);">0% de los objetivos semanales completados</p>
      </div>
    </div>
  </section>

  <!-- SECCI√ìN 2: COMPETENCIAS -->
  <section class="section" id="s2">
    <div class="container">
      <h2>üéØ Competencias del Nivel A1.2-A2.1</h2>
      <div class="grid grid-3">
        <div class="card">
          <h3>üìñ Comprensi√≥n</h3>
          <ul class="list">
            <li><strong>Comprensi√≥n auditiva:</strong> Instrucciones simples, preguntas b√°sicas y conversaciones cotidianas.</li>
            <li><strong>Comprensi√≥n lectora:</strong> Textos cortos, mensajes, emails y documentos sencillos.</li>
            <li><strong>Vocabulario b√°sico:</strong> 800-1000 palabras esenciales para la vida diaria.</li>
          </ul>
        </div>
        <div class="card">
          <h3>üí¨ Interacci√≥n y expresi√≥n</h3>
          <ul class="list">
            <li><strong>Conversaci√≥n b√°sica:</strong> Presentarse, hablar de gustos, rutina diaria y planes.</li>
            <li><strong>Situaciones pr√°cticas:</strong> En restaurante, tienda, transporte, asking for directions.</li>
            <li><strong>Descripciones simples:</strong> Personas, lugares, objetos y actividades cotidianas.</li>
          </ul>
        </div>
        <div class="card">
          <h3>‚úçÔ∏è Producci√≥n escrita</h3>
          <ul class="list">
            <li><strong>Redacciones b√°sicas:</strong> Emails, mensajes, postales y notas cortas.</li>
            <li><strong>Formularios sencillos:</strong> Informaci√≥n personal, datos b√°sicos.</li>
            <li><strong>Gram√°tica esencial:</strong> Presente, pasado simple, futuro pr√≥ximo y estructuras b√°sicas.</li>
          </ul>
        </div>
      </div>
    </div>
  </section>

  <!-- SECCI√ìN 3: TEMARIO -->
  <section class="section" id="s3">
    <div class="container">
      <h2>üóÇÔ∏è Temario del curso</h2>
      <div class="grid grid-3">
        <div class="card">
          <h3>M√≥dulo 1: Comunicaci√≥n b√°sica</h3>
          <ul class="list">
            <li>Saludos y presentaciones formales e informales</li>
            <li>Alfabeto y pronunciaci√≥n espa√±ola</li>
            <li>N√∫meros, fechas y horas</li>
            <li>Nacionalidades y pa√≠ses de habla hispana</li>
            <li>Familia y relaciones personales</li>
          </ul>
        </div>
        <div class="card">
          <h3>M√≥dulo 2: Vida cotidiana</h3>
          <ul class="list">
            <li>Rutina diaria y actividades</li>
            <li>Comida y restaurantes</li>
            <li>Compras y tiendas</li>
            <li>Transporte y direcciones</li>
            <li>Tiempo libre y hobbies</li>
          </ul>
        </div>
        <div class="card">
          <h3>M√≥dulo 3: Situaciones pr√°cticas</h3>
          <ul class="list">
            <li>En el hotel y aeropuerto</li>
            <li>Visitas m√©dicas y farmacia</li>
            <li>Bancos y dinero</li>
            <li>Tel√©fono y comunicaci√≥n digital</li>
            <li>Cultura y costumbres espa√±olas</li>
          </ul>
        </div>
      </div>
    </div>
  </section>

  <!-- SECCI√ìN DE PR√ÅCTICA AVANZADA -->
  <section class="section" style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); padding: 2rem 0;">
    <div class="container">
      <h2>üó£Ô∏è Pr√°ctica de Conversaci√≥n y Gram√°tica</h2>

      <div class="card">
        <h3>üé≠ Escenarios de Conversaci√≥n</h3>
        <p>Situaciones reales para practicar tu espa√±ol. Practica con un compa√±ero o graba tu voz.</p>

        <div class="grid grid-3" id="conversationScenarios">
          <div class="scenario-card" style="background: white; border: 2px solid #f59e0b; border-radius: 0.75rem; padding: 1rem; margin: 0.5rem 0; cursor: pointer; transition: all 0.3s ease;">
            <h4 style="color: #92400e; margin: 0 0 0.5rem 0;">üçΩÔ∏è En el Restaurante</h4>
            <p style="margin: 0; font-size: 0.9rem;">Pedir comida, hacer preguntas sobre el men√∫, pagar la cuenta</p>
            <button class="btn" style="margin-top: 0.5rem; padding: 0.4rem 0.8rem; font-size: 0.8rem;" onclick="showDialog('restaurant')">Ver Di√°logo</button>
          </div>

          <div class="scenario-card" style="background: white; border: 2px solid #f59e0b; border-radius: 0.75rem; padding: 1rem; margin: 0.5rem 0; cursor: pointer; transition: all 0.3s ease;">
            <h4 style="color: #92400e; margin: 0 0 0.5rem 0;">üó∫Ô∏è Pidiendo Direcciones</h4>
            <p style="margin: 0; font-size: 0.9rem;">C√≥mo llegar a lugares, entender indicaciones, vocabulario de direcciones</p>
            <button class="btn" style="margin-top: 0.5rem; padding: 0.4rem 0.8rem; font-size: 0.8rem;" onclick="showDialog('directions')">Ver Di√°logo</button>
          </div>

          <div class="scenario-card" style="background: white; border: 2px solid #f59e0b; border-radius: 0.75rem; padding: 1rem; margin: 0.5rem 0; cursor: pointer; transition: all 0.3s ease;">
            <h4 style="color: #92400e; margin: 0 0 0.5rem 0;">üõçÔ∏è En la Tienda</h4>
            <p style="margin: 0; font-size: 0.9rem;">Comprar ropa, preguntar precios, talla y calidad</p>
            <button class="btn" style="margin-top: 0.5rem; padding: 0.4rem 0.8rem; font-size: 0.8rem;" onclick="showDialog('shopping')">Ver Di√°logo</button>
          </div>

          <div class="scenario-card" style="background: white; border: 2px solid #f59e0b; border-radius: 0.75rem; padding: 1rem; margin: 0.5rem 0; cursor: pointer; transition: all 0.3s ease;">
            <h4 style="color: #92400e; margin: 0 0 0.5rem 0;">‚öïÔ∏è En la Farmacia</h4>
            <p style="margin: 0; font-size: 0.9rem;">Describir s√≠ntomas, pedir medicamentos, vocabulario m√©dico</p>
            <button class="btn" style="margin-top: 0.5rem; padding: 0.4rem 0.8rem; font-size: 0.8rem;" onclick="showDialog('pharmacy')">Ver Di√°logo</button>
          </div>

          <div class="scenario-card" style="background: white; border: 2px solid #f59e0b; border-radius: 0.75rem; padding: 1rem; margin: 0.5rem 0; cursor: pointer; transition: all 0.3s ease;">
            <h4 style="color: #92400e; margin: 0 0 0.5rem 0;">üè® En el Hotel</h4>
            <p style="margin: 0; font-size: 0.9rem;">Hacer reservas, pedir informaci√≥n, servicios del hotel</p>
            <button class="btn" style="margin-top: 0.5rem; padding: 0.4rem 0.8rem; font-size: 0.8rem;" onclick="showDialog('hotel')">Ver Di√°logo</button>
          </div>

          <div class="scenario-card" style="background: white; border: 2px solid #f59e0b; border-radius: 0.75rem; padding: 1rem; margin: 0.5rem 0; cursor: pointer; transition: all 0.3s ease;">
            <h4 style="color: #92400e; margin: 0 0 0.5rem 0;">üöå Transporte P√∫blico</h4>
            <p style="margin: 0; font-size: 0.9rem;">Comprar billetes, preguntar rutas, horarios</p>
            <button class="btn" style="margin-top: 0.5rem; padding: 0.4rem 0.8rem; font-size: 0.8rem;" onclick="showDialog('transport')">Ver Di√°logo</button>
          </div>
        </div>

        <div style="margin-top: 1.5rem; text-align: center;">
          <button class="btn primary" onclick="downloadConversationGuide()">üìÑ Descargar Gu√≠a Completa</button>
          <button class="btn" onclick="startConversationPractice()">üé§ Iniciar Pr√°ctica Guiada</button>
        </div>
      </div>

      <div class="card" style="margin-top: 1rem;">
        <h3>üìù Ejercicios de Gram√°tica Interactivos</h3>
        <p>Practica las estructuras gramaticales m√°s importantes para el nivel A1.2-A2.1</p>

        <div id="grammarExercises">
          <div style="margin: 1rem 0; padding: 1rem; background: white; border-radius: 0.5rem; border: 1px solid #e5e7eb;">
            <h4 style="color: var(--primary-color); margin: 0 0 0.5rem 0;">SER vs ESTAR</h4>
            <p style="margin: 0 0 0.5rem 0;">Elige la forma correcta:</p>
            <div style="margin: 0.5rem 0;">
              <p>Yo _____ estudiante de espa√±ol. (ser/estar)</p>
              <input type="text" id="grammar1" placeholder="Tu respuesta" style="padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.25rem; width: 200px;">
              <button class="btn" style="margin-left: 0.5rem;" onclick="checkGrammarAnswer(1, 'soy')">Verificar</button>
            </div>
            <div style="margin: 0.5rem 0;">
              <p>La clase _____ muy interesante hoy. (ser/estar)</p>
              <input type="text" id="grammar2" placeholder="Tu respuesta" style="padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.25rem; width: 200px;">
              <button class="btn" style="margin-left: 0.5rem;" onclick="checkGrammarAnswer(2, 'est√°')">Verificar</button>
            </div>
          </div>

          <div style="margin: 1rem 0; padding: 1rem; background: white; border-radius: 0.5rem; border: 1px solid #e5e7eb;">
            <h4 style="color: var(--primary-color); margin: 0 0 0.5rem 0;">Verbos Irregulares</h4>
            <p style="margin: 0 0 0.5rem 0;">Conjugaci√≥n correcta:</p>
            <div style="margin: 0.5rem 0;">
              <p>Yo _____ (tener) muchos amigos en Granada.</p>
              <input type="text" id="grammar3" placeholder="Tu respuesta" style="padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.25rem; width: 200px;">
              <button class="btn" style="margin-left: 0.5rem;" onclick="checkGrammarAnswer(3, 'tengo')">Verificar</button>
            </div>
            <div style="margin: 0.5rem 0;">
              <p>¬øQu√© _____ (hacer) este fin de semana?</p>
              <input type="text" id="grammar4" placeholder="Tu respuesta" style="padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.25rem; width: 200px;">
              <button class="btn" style="margin-left: 0.5rem;" onclick="checkGrammarAnswer(4, 'haces')">Verificar</button>
            </div>
          </div>
        </div>

        <div style="margin-top: 1rem; text-align: center;">
          <button class="btn primary" onclick="loadNewGrammarExercises()">üîÑ Nuevos Ejercicios</button>
          <button class="btn" onclick="showGrammarSolutions()">üí° Ver Soluciones</button>
        </div>
      </div>

      <div class="card" style="margin-top: 1rem;">
        <h3>üéÆ Gamificaci√≥n: Retos Diarios</h3>
        <p>Completa estos retos para ganar puntos y mejorar tu espa√±ol</p>

        <div id="dailyChallenges" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin: 1rem 0;">
          <div style="padding: 1rem; background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); border-radius: 0.5rem; text-align: center;">
            <div style="font-size: 2rem;">üéß</div>
            <h4 style="margin: 0.5rem 0; color: #1e40af;">Escucha Activa</h4>
            <p style="margin: 0 0 0.5rem 0; font-size: 0.9rem;">Escucha una canci√≥n en espa√±ol e identifica 5 palabras nuevas</p>
            <div style="font-weight: bold; color: #059669;">+10 puntos</div>
          </div>

          <div style="padding: 1rem; background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%); border-radius: 0.5rem; text-align: center;">
            <div style="font-size: 2rem;">üìñ</div>
            <h4 style="margin: 0.5rem 0; color: #166534;">Lectura Corta</h4>
            <p style="margin: 0 0 0.5rem 0; font-size: 0.9rem;">Lee una noticia breve en espa√±ol y resume 3 ideas principales</p>
            <div style="font-weight: bold; color: #059669;">+15 puntos</div>
          </div>

          <div style="padding: 1rem; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 0.5rem; text-align: center;">
            <div style="font-size: 2rem;">üó£Ô∏è</div>
            <h4 style="margin: 0.5rem 0; color: #92400e;">Conversaci√≥n</h4>
            <p style="margin: 0 0 0.5rem 0; font-size: 0.9rem;">Practica un di√°logo con un compa√±ero durante 5 minutos</p>
            <div style="font-weight: bold; color: #059669;">+20 puntos</div>
          </div>
        </div>

        <div style="text-align: center; margin-top: 1rem;">
          <div style="font-size: 1.5rem; font-weight: bold; color: var(--brand);">
            üèÜ Tu Puntuaci√≥n: <span id="userPoints">0</span> puntos
          </div>
          <p style="margin: 0.5rem 0; color: var(--muted-color); font-size: 0.9rem;">
            ¬°Sigue practicando para alcanzar la pr√≥xima meta de 100 puntos!
          </p>
        </div>
      </div>
    </div>
  </section>

  <!-- SECCI√ìN 4: PROYECTOS -->
  <section class="section" id="s4">
    <div class="container">
      <h2>üß≠ Proyectos y actividades</h2>
      <div class="grid grid-3">
        <div class="card">
          <h3>üé≠ Role-playing diario</h3>
          <p>Escenificaciones de situaciones reales: pedir caf√©, comprar billetes, pedir direcciones, hacer reservas.</p>
          <ul class="list">
            <li>Restaurante espa√±ol</li>
            <li>Estaci√≥n de tren</li>
            <li>Tienda de ropa</li>
            <li>Oficina de turismo</li>
          </ul>
        </div>
        <div class="card">
          <h3>üì∏ Proyecto fotogr√°fico</h3>
          <p>"Mi d√≠a en Granada" - Documentaci√≥n fotogr√°fica con descripciones en espa√±ol de lugares y experiencias.</p>
          <ul class="list">
            <li>Visitas a lugares emblem√°ticos</li>
            <li>Descripci√≥n de fotos en espa√±ol</li>
            <li>Presentaci√≥n oral del proyecto</li>
            <li>Peque√±a gu√≠a tur√≠stica personal</li>
          </ul>
        </div>
        <div class="card">
          <h3>üç≥ Taller de cocina espa√±ola</h3>
          <p>Actividad pr√°ctica para aprender vocabulario de cocina y seguir instrucciones en espa√±ol.</p>
          <ul class="list">
            <li>Tortilla espa√±ola</li>
            <li>Gazpacho andaluz</li>
            <li>Recetas biling√ºes</li>
            <li>Video tutorial explicando el proceso</li>
          </ul>
        </div>
      </div>
    </div>
  </section>

  <!-- SECCI√ìN 5: EVALUACI√ìN -->
  <section class="section" id="s5">
    <div class="container">
      <h2>üìä Evaluaci√≥n</h2>
      <div class="grid grid-3">
        <div class="card">
          <h3>Asistencia y participaci√≥n</h3>
          <p>Asistencia m√≠nima del 85% para ser evaluado.</p>
          <h3 style="margin-top:.5rem">Sistema espa√±ol</h3>
          <p>Sobresaliente (9‚Äì10), Notable (7‚Äì8.99), Aprobado (5‚Äì6.99), Suspenso (0‚Äì4.99).</p>
        </div>
        <div class="card">
          <h3>60% ¬∑ Evaluaci√≥n continua</h3>
          <ul class="list">
            <li>Participaci√≥n activa en clase (20%)</li>
            <li>Tareas diarias y homework (15%)</li>
            <li>Proyecto fotogr√°fico (15%)</li>
            <li>Taller de cocina (10%)</li>
          </ul>
        </div>
        <div class="card">
          <h3>40% ¬∑ Pruebas finales</h3>
          <ul class="list">
            <li>Examen oral: conversaci√≥n b√°sica (20%)</li>
            <li>Examen escrito: comprensi√≥n y expresi√≥n (20%)</li>
            <li>Evaluaci√≥n pr√°ctica en situaciones reales</li>
          </ul>
        </div>
      </div>
    </div>
  </section>

  <!-- DESCARGAS -->
  <section class="section" id="descargas">
    <div class="container">
      <h2>üì• Descargas</h2>
      <div class="card">
        <table>
          <thead><tr><th>Documento</th><th>Acci√≥n</th></tr></thead>
          <tbody>
            <tr><td>Gu√≠a del curso (PDF)</td><td><button class="btn" data-pdf="materials/guia-curso.pdf">Abrir/descargar</button></td></tr>
            <tr><td>Vocabulario esencial (PDF)</td><td><button class="btn" data-pdf="materials/vocabulario.pdf">Abrir/descargar</button></td></tr>
            <tr><td>Frases √∫tiles (PDF)</td><td><button class="btn" data-pdf="materials/frases-utiles.pdf">Abrir/descargar</button></td></tr>
            <tr><td>Verbos irregulares (PDF)</td><td><button class="btn" data-pdf="materials/verbos.pdf">Abrir/descargar</button></td></tr>
          </tbody>
        </table>
        <p class="muted" style="margin-top:.4rem">Sube tus PDF a <code>materials/</code> con estos nombres o c√°mbialos aqu√≠.</p>
      </div>
    </div>
  </section>

  <!-- FORO -->
  <section class="section" id="foro">
    <div class="container">
      <h2>üí¨ Foro</h2>
      <div class="card">
        <p>Usaremos el foro/plataforma del centro.</p>
        <p><a class="btn primary" href="#" target="_blank" rel="noreferrer">Abrir foro</a></p>
      </div>
    </div>
  </section>

  <!-- TALLER -->
  <section class="section" id="taller">
    <div class="container">
      <h2>üõ†Ô∏è Taller de pr√°ctica</h2>
      <div class="card">
        <div class="grid" style="grid-template-columns:1fr;gap:1rem">
          <label>Actividad
            <select id="obra">
              <option>Conversaci√≥n b√°sica</option>
              <option>Pedir en restaurante</option>
              <option>Comprar en tienda</option>
              <option>Pedir direcciones</option>
              <option>Presentaci√≥n personal</option>
            </select>
          </label>
          <label>Situaci√≥n
            <input id="titulo" placeholder="Ej.: En el restaurante espa√±ol" />
          </label>
          <label>Di√°logo / Frases √∫tiles
            <textarea id="guion" rows="8" placeholder="Escribe aqu√≠ las frases y di√°logos para practicar..."></textarea>
          </label>
          <div style="display:flex;gap:.5rem;flex-wrap:wrap">
            <button class="btn primary" id="guardar">Descargar .txt</button>
            <button class="btn" id="plantilla">Cargar plantilla</button>
            <button class="btn" id="limpiar">Limpiar</button>
          </div>
        </div>
        <p class="muted" style="margin-top:.75rem">La descarga funciona sin servidor: genera un archivo de texto al momento.</p>
      </div>
    </div>
  </section>

  <footer class="footer"><div class="container">¬© <span id="y"></span> Curso Intensivo de Espa√±ol ‚Äî Nivel 3 CLM ¬∑ Universidad de Granada</div></footer>

  <!-- Visor de Documentos -->
  <div class="overlay" id="overlay"></div>
  <div class="viewer" id="viewer">
    <div class="top">
      <strong id="fileName">Documento</strong>
      <div class="spacer"></div>
      <a class="btn" id="openTab" target="_blank" rel="noopener">Abrir en pesta√±a</a>
      <a class="btn" id="download" download>Descargar</a>
      <button class="btn primary" id="closeViewer">Volver</button>
    </div>
    <iframe id="frame" title="Visor PDF" src="about:blank" style="display:none;"></iframe>
    <div id="textcontent" class="content" style="display:none;"></div>
  </div>

  <script>
    // A√±o
    document.getElementById('y').textContent = new Date().getFullYear();

    // Men√∫ m√≥vil
    const nav = document.getElementById('nav');
    const hamb = document.getElementById('hamb');
    hamb?.addEventListener('click', ()=> nav.classList.toggle('open'));
    document.querySelectorAll('#mobilePanel a').forEach(a=> a.addEventListener('click', ()=> nav.classList.remove('open')));

    // Visor de Documentos
    const overlay = document.getElementById('overlay');
    const viewer = document.getElementById('viewer');
    const frame = document.getElementById('frame');
    const textcontent = document.getElementById('textcontent');
    const openTab = document.getElementById('openTab');
    const download = document.getElementById('download');
    const fileName = document.getElementById('fileName');
    const closeViewer = document.getElementById('closeViewer');

    function formatTextContent(text) {
      let formatted = text
        .replace(/\n\n+/g, '</p><p>')
        .replace(/^\S+/m, '<p>')
        .replace(/([A-Z][A-Z√Å-√ö\s]+:)/g, '<strong>$1</strong>')
        .replace(/SESI√ìN (\d+):/g, '<h1>SESI√ìN $1:')
        .replace(/(\d+\.\s[^:]+:)/g, '<h2>$1</h2>')
        .replace(/^‚Ä¢\s(.+)$/gm, '<li>$1</li>')
        .replace(/^- (.+)$/gm, '<li>$1</li>');

      formatted = formatted.replace(/(<li>.*?<\/li>)/gs, '<ul>$1</ul>');
      formatted += '</p>';

      return formatted;
    }

    async function openDocument(path){
      fileName.textContent = decodeURIComponent(path.split('/').pop());
      const extension = path.split('.').pop().toLowerCase();

      openTab.href = path;
      download.href = path;
      overlay.classList.add('show');
      viewer.style.display = 'flex';
      document.body.style.overflow = 'hidden';

      if (extension === 'pdf') {
        frame.style.display = 'block';
        textcontent.style.display = 'none';
        frame.src = path;
      } else if (extension === 'txt' || extension === 'rtf') {
        frame.style.display = 'none';
        textcontent.style.display = 'block';

        try {
          const response = await fetch(path);
          if (!response.ok) throw new Error('No se pudo cargar el archivo');

          let text = await response.text();

          if (extension === 'rtf') {
            text = text.replace(/\\[^a-zA-Z]+\d*/g, '')
                      .replace(/\{[^}]*\}/g, '')
                      .replace(/\\par/g, '\n')
                      .replace(/\\tab/g, '  ')
                      .replace(/\\'d[0-9a-fA-F]{2}/g, '')
                      .replace(/\\[a-zA-Z]+\s*/g, '');
          }

          textcontent.innerHTML = formatTextContent(text);
        } catch (error) {
          textcontent.innerHTML = `<p>Error al cargar el documento: ${error.message}</p>`;
        }
      } else {
        window.open(path, '_blank');
        closeDocument();
      }
    }

    function closeDocument(){
      overlay.classList.remove('show');
      viewer.style.display = 'none';
      frame.src = 'about:blank';
      textcontent.innerHTML = '';
      document.body.style.overflow = '';
    }

    overlay.addEventListener('click', closeDocument);
    closeViewer.addEventListener('click', closeDocument);

    document.addEventListener('click', (e)=>{
      const target = e.target.closest('[data-pdf], [data-doc]');
      if(target){
        e.preventDefault();
        const path = target.getAttribute('data-pdf') || target.getAttribute('data-doc');
        openDocument(path);
      }
    });

    // ===== MATERIALES DEL CURSO =====
    function renderMaterialesCurso(){
      try {
        const chips = document.getElementById('chips-materials');
        const list = document.getElementById('lista-materials');

        if (!chips || !list) {
          console.error('Elements not found: chips-materials or lista-materials');
          return;
        }

        chips.innerHTML = '';
        list.innerHTML = '';

        const materiales = [
          { t: 'Guia del curso', href: 'materials/guia-curso.pdf' },
          { t: 'Vocabulario esencial', href: 'materials/vocabulario.pdf' },
          { t: 'Frases utiles', href: 'materials/frases-utiles.pdf' },
          { t: 'Verbos irregulares', href: 'materials/verbos.pdf' },
          { t: 'Ejercicios practicos', href: 'materials/ejercicios-practicos.pdf' },
          { t: 'Practicas de conversacion', href: 'materials/conversaciones-practicas.pdf' },
          { t: 'Guia cultural Granada', href: 'materials/guia-cultural-granada.pdf' },
          { t: 'Tarjetas de nombres', href: 'materials/tarjetas/nombres_personajes.pdf' },
          { t: 'Menus de tapas', href: 'materials/menus/menues_tapas.pdf' },
          { t: 'Flashcards vocabulario', href: 'materials/vocabulario/flashcards_sesion1-6.pdf' },
          { t: 'Ejercicios basicos', href: 'materials/plantillas/ejercicios_basicos.pdf' },
          { t: 'Calendarios y horarios', href: 'materials/calendarios/calendario_horarios.pdf' }
        ];

        materiales.forEach((m) => {
          const span = document.createElement('span');
          span.className = 'chip';
          span.textContent = m.t;

          span.onclick = () => {
            document.querySelectorAll('#chips-materials .chip').forEach(c=>c.classList.remove('active'));
            span.classList.add('active');

            const fileName = m.href.split('/').pop();

            list.innerHTML = `
              <li><button class="btn primary" data-pdf="${m.href}">üìÑ Ver en navegador</button></li>
              <li><button class="btn" onclick="window.open('${m.href}', '_blank')">üîó Abrir en nueva pesta√±a</button></li>
              <li><button class="btn" onclick="downloadFile('${m.href}', '${fileName}')">üíæ Descargar directamente</button></li>
              <li><button class="btn" onclick="copyPDFLink('${m.href}')">üìã Copiar enlace</button></li>
            `;
          };
          chips.appendChild(span);
        });

        // Seleccionar el primer material autom√°ticamente
        if (materiales.length > 0) {
          setTimeout(() => {
            const firstChip = chips.querySelector('.chip');
            if (firstChip) {
              firstChip.click();
            }
          }, 100);
        }
      } catch (error) {
        console.error('Error in renderMaterialesCurso:', error);
      }
    }

    // ===== GU√çAS POR SESI√ìN =====
    const GUIAS_S1 = [
      { t: 'Sesi√≥n 1 ¬∑ Presentaciones y alfabeto', href: 'materials/cuadernos/S1_Espanol_Intensivo.pdf', type: 'pdf' },
      { t: 'Sesi√≥n 2 ¬∑ N√∫meros y fechas', href: 'materials/cuadernos/S2_Espanol_Intensivo.pdf', type: 'pdf' },
      { t: 'Sesi√≥n 3 ¬∑ Familia y descripciones', href: 'materials/cuadernos/S3_Espanol_Intensivo.pdf', type: 'pdf' },
      { t: 'Sesi√≥n 4 ¬∑ Rutina diaria', href: 'materials/cuadernos/S4_Espanol_Intensivo.pdf', type: 'pdf' },
      { t: 'Sesi√≥n 5 ¬∑ Comida y restaurante', href: 'materials/cuadernos/S5_Espanol_Intensivo.pdf', type: 'pdf' },
      { t: 'Sesi√≥n 6 ¬∑ Taller de cocina', href: 'materials/cuadernos/S10_Espanol_Intensivo.pdf', type: 'pdf' },
      { t: 'Sesi√≥n 7 ¬∑ Compras y tiendas', href: 'materials/cuadernos/S6_Espanol_Intensivo.pdf', type: 'pdf' },
      { t: 'Sesi√≥n 8 ¬∑ Transporte y direcciones', href: 'materials/cuadernos/S7_Espanol_Intensivo.pdf', type: 'pdf' },
      { t: 'Sesi√≥n 9 ¬∑ Tiempo libre y hobbies', href: 'materials/cuadernos/S8_Espanol_Intensivo.pdf', type: 'pdf' },
      { t: 'Sesi√≥n 10 ¬∑ Proyecto fotogr√°fico', href: 'materials/cuadernos/S9_Espanol_Intensivo.pdf', type: 'pdf' },
      { t: 'Sesi√≥n 11 ¬∑ Tecnolog√≠a y comunicaci√≥n', href: 'materials/cuadernos/S16_Espanol_Intensivo.pdf', type: 'pdf' },
      { t: 'Sesi√≥n 12 ¬∑ Proyecto final integrador', href: 'materials/cuadernos/S17_Espanol_Intensivo.pdf', type: 'pdf' },
      { t: 'Sesi√≥n 13 ¬∑ Cultura y regiones de Espa√±a', href: 'materials/cuadernos/S13_Espanol_Intensivo.pdf', type: 'pdf' },
      { t: 'Sesi√≥n 14 ¬∑ Salud y emergencias', href: 'materials/cuadernos/S14_Espanol_Intensivo.pdf', type: 'pdf' },
      { t: 'Sesi√≥n 15 ¬∑ Viajes y alojamiento', href: 'materials/cuadernos/S15_Espanol_Intensivo.pdf', type: 'pdf' },
      { t: 'Sesi√≥n 16 ¬∑ Repaso general', href: 'materials/cuadernos/S11_Espanol_Intensivo.pdf', type: 'pdf' },
      { t: 'Sesi√≥n 17 ¬∑ Evaluaci√≥n final', href: 'materials/cuadernos/S12_Espanol_Intensivo.pdf', type: 'pdf' },
    ];

    const SESSIONS_AVAILABLE = [
      'S1_Espanol_Intensivo.pdf',
      'S2_Espanol_Intensivo.pdf',
      'S3_Espanol_Intensivo.pdf',
      'S4_Espanol_Intensivo.pdf',
      'S5_Espanol_Intensivo.pdf',
      'S6_Espanol_Intensivo.pdf',
      'S7_Espanol_Intensivo.pdf',
      'S8_Espanol_Intensivo.pdf',
      'S9_Espanol_Intensivo.pdf',
      'S10_Espanol_Intensivo.pdf',
      'S11_Espanol_Intensivo.pdf',
      'S12_Espanol_Intensivo.pdf',
      'S13_Espanol_Intensivo.pdf',
      'S14_Espanol_Intensivo.pdf',
      'S15_Espanol_Intensivo.pdf',
      'S16_Espanol_Intensivo.pdf',
      'S17_Espanol_Intensivo.pdf'
    ];

    // Materiales adicionales por sesi√≥n
    const MATERIALES_ADICIONALES = {
      3: [
        { nombre: 'üìä Presentaci√≥n: Familia y Descripciones', href: 'materials/familia-y-descripciones.pdf' }
      ],
      4: [
        { nombre: 'üåç Presentaci√≥n: Rutina Diaria y Choque Cultural', href: 'materials/presentaciones/S4_Rutina_Diaria_Choque_Cultural.pdf' }
      ],
      5: [
        { nombre: 'üçΩÔ∏è Presentaci√≥n: Tapas Espa√±olas', href: 'materials/Tapas.pdf' }
      ]
    };

    function renderGuiasS1(){
      const chips = document.getElementById('chips-s1');
      const list = document.getElementById('lista-s1');
      chips.innerHTML = ''; list.innerHTML = '';

      GUIAS_S1.forEach((s, index) => {
        const span = document.createElement('span');
        span.className = 'chip';
        span.textContent = s.t;

        span.onclick = () => {
          document.querySelectorAll('#chips-s1 .chip').forEach(c=>c.classList.remove('active'));
          span.classList.add('active');

          const fileName = s.href.split('/').pop();
          const fileExists = SESSIONS_AVAILABLE.includes(fileName);
          const sessionNumber = index + 1;

          // Handle web links (miniwebs)
          if (s.type === 'web') {
            let htmlContent = `
              <li><button class="btn primary" onclick="window.open('${s.href}', '_blank')">üåê Abrir miniweb</button></li>
              <li><button class="btn" onclick="copyPDFLink('${s.href}')">üìã Copiar enlace</button></li>
            `;
            list.innerHTML = htmlContent;
            return;
          }

          if (fileExists) {
            const isPDF = s.type === 'pdf' || s.href.endsWith('.pdf');
            const fileIcon = isPDF ? 'üìÑ' : 'üìù';
            const dataAttr = isPDF ? 'data-pdf' : 'data-doc';

          // A√±adir enlace a miniweb si es la sesi√≥n 8, 9, 10 u 11
            let miniwebLink = '';
            if (s.t.includes('Sesi√≥n 8')) {
              miniwebLink = `<li><button class="btn" onclick="window.open('https://elcorreveidile.github.io/Curso-Intensivo-Espanol/materials/miniweb/direcciones/', '_blank')" style="background: #27ae60;">üåê MiniWeb: Transporte y Direcciones</button></li>`;
            } else if (s.t.includes('Sesi√≥n 9')) {
              miniwebLink = `<li><button class="btn" onclick="window.open('https://elcorreveidile.github.io/Curso-Intensivo-Espanol/materials/miniweb/ocio/', '_blank')" style="background: #667eea;">üåê MiniWeb: Ocio y Aficiones</button></li>`;
            } else if (s.t.includes('Sesi√≥n 10')) {
              miniwebLink = `<li><button class="btn" onclick="window.open('https://elcorreveidile.github.io/Curso-Intensivo-Espanol/materials/miniweb/fotos/', '_blank')" style="background: #ff6b6b;">üåê MiniWeb: Proyecto de Fotos</button></li>`;
            } else if (s.t.includes('Sesi√≥n 11')) {
              miniwebLink = `<li><button class="btn" onclick="window.open('https://elcorreveidile.github.io/Curso-Intensivo-Espanol/materials/miniweb/tecnologia/', '_blank')" style="background: #0ea5e9;">üåê MiniWeb: Tecnolog√≠a y Comunicaci√≥n</button></li>`;
            }

            let htmlContent = `
              <li><button class="btn primary" ${dataAttr}="${s.href}">${fileIcon} Ver en navegador (${s.t})</button></li>
              <li><button class="btn" onclick="window.open('${s.href}', '_blank')">üîó Abrir en nueva pesta√±a</button></li>
              <li><button class="btn" onclick="downloadFile('${s.href}', '${s.t}.pdf')">üíæ Descargar directamente</button></li>
              <li><button class="btn" onclick="copyPDFLink('${s.href}')">üìã Copiar enlace</button></li>
              ${miniwebLink}
            `;

            // A√±adir materiales adicionales si existen
            if (MATERIALES_ADICIONALES[sessionNumber]) {
              htmlContent += '<li style="margin-top: 15px; padding-top: 10px; border-top: 1px solid #e5e7eb;"><strong>Materiales adicionales:</strong></li>';
              MATERIALES_ADICIONALES[sessionNumber].forEach(material => {
                htmlContent += `
                  <li><button class="btn" data-pdf="${material.href}">${material.nombre}</button></li>
                `;
              });
            }

            list.innerHTML = htmlContent;
          } else {
            list.innerHTML = `
              <li class="muted">üìù ${s.t}</li>
              <li class="muted" style="font-size: 0.9rem; margin-top: 10px;">
                ‚ö†Ô∏è Este material estar√° disponible pr√≥ximamente.<br>
                Los materiales del curso se ir√°n subiendo seg√∫n avance el programa.
              </li>
            `;
          }
        };
        chips.appendChild(span);
      });

      if(GUIAS_S1[0]) setTimeout(()=> chips.querySelector('.chip')?.click(), 0);
      else list.innerHTML = '<li class="muted">No hay gu√≠as subidas todav√≠a.</li>';
    }

    function downloadFile(url, filename) {
      // Para archivos PDF, intentar m√∫ltiples m√©todos
      if (url.endsWith('.pdf')) {
        // M√©todo 1: Abrir en nueva pesta√±a (m√©todo m√°s compatible)
        const newWindow = window.open(url, '_blank');

        // M√©todo 2: Si el popup es bloqueado, intentar descarga directa
        if (!newWindow || newWindow.closed || typeof newWindow.closed === 'undefined') {
          const a = document.createElement('a');
          a.href = url;
          a.target = '_blank';
          a.download = filename;

          // A√±adir al DOM y hacer click
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);

          // Mostrar mensaje de ayuda al usuario
          showPDFHelpMessage();
        }
      } else {
        // Para archivos no PDF, usar m√©todo normal
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      }
    }

    function showPDFHelpMessage() {
      // Crear mensaje temporal para ayudar al usuario
      const message = document.createElement('div');
      message.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #1e40af;
        color: white;
        padding: 15px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        z-index: 1000;
        max-width: 300px;
        font-size: 14px;
      `;
      message.innerHTML = `
        <strong>üí° Ayuda:</strong><br>
        Si el PDF no se abre, revisa las pesta√±as emergentes o la barra de descargas.
        <button onclick="this.parentElement.remove()" style="
          background: white;
          color: #1e40af;
          border: none;
          padding: 4px 8px;
          border-radius: 4px;
          margin-left: 10px;
          cursor: pointer;
        ">√ó</button>
      `;

      document.body.appendChild(message);

      // Auto-eliminar despu√©s de 8 segundos
      setTimeout(() => {
        if (message.parentElement) {
          message.remove();
        }
      }, 8000);
    }

    function copyPDFLink(url) {
      // Obtener la URL completa del servidor actual
      const fullUrl = window.location.origin + '/' + url;

      // Copiar al portapapeles
      if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(fullUrl).then(() => {
          showCopySuccessMessage();
        }).catch(() => {
          fallbackCopyTextToClipboard(fullUrl);
        });
      } else {
        fallbackCopyTextToClipboard(fullUrl);
      }
    }

    function fallbackCopyTextToClipboard(text) {
      const textArea = document.createElement('textarea');
      textArea.value = text;
      textArea.style.position = 'fixed';
      textArea.style.left = '-999999px';
      textArea.style.top = '-999999px';
      document.body.appendChild(textArea);
      textArea.focus();
      textArea.select();

      try {
        document.execCommand('copy');
        showCopySuccessMessage();
      } catch (err) {
        console.error('Error al copiar el texto: ', err);
      }

      document.body.removeChild(textArea);
    }

    function showCopySuccessMessage() {
      const message = document.createElement('div');
      message.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #059669;
        color: white;
        padding: 15px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        z-index: 1000;
        font-size: 14px;
      `;
      message.innerHTML = `
        <strong>‚úÖ ¬°Enlace copiado!</strong><br>
        Ya puedes compartir el PDF.
        <button onclick="this.parentElement.remove()" style="
          background: white;
          color: #059669;
          border: none;
          padding: 4px 8px;
          border-radius: 4px;
          margin-left: 10px;
          cursor: pointer;
        ">√ó</button>
      `;

      document.body.appendChild(message);

      setTimeout(() => {
        if (message.parentElement) {
          message.remove();
        }
      }, 4000);
    }

    // Sistema de Asistencia QR
    let qrTimer;
    let currentToken;
    let timeRemaining = 300;

    function generateToken() {
      const timestamp = Date.now();
      const random = Math.random().toString(36).substring(7);
      return `${timestamp}-${random}`;
    }

    function generateQR() {
      currentToken = generateToken();

      const now = new Date();
      const date = now.toISOString().split('T')[0];
      const time = now.toTimeString().split(' ')[0].substring(0, 5);
      const sessionId = `${date}_${time}`;

      const qrData = {
        sessionId: sessionId,
        timestamp: now.toISOString(),
        type: 'attendance'
      };

      const baseUrl = 'https://elcorreveidile.github.io';
      const attendanceUrl = `${baseUrl}/Curso-Intensivo-Espanol/attendance-register.html?v=2&qr=${encodeURIComponent(JSON.stringify(qrData))}`;

      document.getElementById('qr-code').innerHTML = '';

      new QRCode(document.getElementById('qr-code'), {
        text: attendanceUrl,
        width: 200,
        height: 200,
        colorDark: '#059669',
        colorLight: '#ffffff',
        correctLevel: QRCode.CorrectLevel.H
      });

      localStorage.setItem('currentQRData', JSON.stringify(qrData));
      localStorage.setItem('currentSession', JSON.stringify({
        sessionId: sessionId,
        timestamp: now.toISOString(),
        date: now.toDateString()
      }));

      timeRemaining = 300;
      startQRTimer();
    }

    function startQRTimer() {
      if (qrTimer) {
        clearInterval(qrTimer);
      }

      const timerElement = document.getElementById('qr-timer');

      qrTimer = setInterval(() => {
        if (timeRemaining <= 0) {
          clearInterval(qrTimer);
          generateQR();
          return;
        }

        const minutes = Math.floor(timeRemaining / 60);
        const seconds = timeRemaining % 60;
        timerElement.textContent = `Expira en: ${minutes}:${seconds.toString().padStart(2, '0')}`;

        if (timeRemaining < 60) {
          timerElement.style.color = '#dc2626';
        } else {
          timerElement.style.color = '#059669';
        }

        timeRemaining--;
      }, 1000);
    }

    function initQRSystem() {
      const qrContainer = document.getElementById('qr-attendance');
      const generateBtn = document.getElementById('generate-new-qr');

      if (qrContainer) {
        generateQR();

        if (generateBtn) {
          generateBtn.addEventListener('click', () => {
            generateQR();
          });
        }

        setInterval(() => {
          generateQR();
        }, 5 * 60 * 1000);
      }
    }

    function updateCurrentDate() {
      const dateElement = document.getElementById('current-date');
      if (dateElement) {
        const today = new Date();
        const days = ['domingo', 'lunes', 'martes', 'mi√©rcoles', 'jueves', 'viernes', 's√°bado'];
        const months = ['enero', 'febrero', 'marzo', 'abril', 'mayo', 'junio', 'julio', 'agosto', 'septiembre', 'octubre', 'noviembre', 'diciembre'];

        const dayName = days[today.getDay()];
        const day = today.getDate();
        const monthName = months[today.getMonth()];
        const year = today.getFullYear();

        dateElement.textContent = `Hoy es ${dayName}, ${day} de ${monthName} de ${year}`;
      }
    }

    // Plantillas para el taller
    const PLANTILLAS = {
      'Conversaci√≥n b√°sica': `Di√°logo: Presentaciones
------------------------
Persona A: Hola, ¬øc√≥mo te llamas?
Persona B: Me llamo [nombre]. ¬øY t√∫?
Persona A: Yo soy [nombre]. ¬øDe d√≥nde eres?
Persona B: Soy de [pa√≠s]. ¬øY t√∫?
Persona A: Soy de [pa√≠s]. Mucho gusto.
Persona B: Encantado/a.`,

      'Pedir en restaurante': `Frases √∫tiles: Restaurante
----------------------------
CAMARERO/A: ¬øQu√© desea tomar?
T√ö: Quisiera...
T√ö: Me pone...
T√ö: Tr√°igame...

Para pedir:
- Una paella
- Un caf√© con leche
- Agua mineral
- La cuenta, por favor

Para preguntar:
- ¬øQu√© me recomienda?
- ¬øCu√°nto cuesta?
- ¬øTiene vegetariano?`,

      'Comprar en tienda': `Frases √∫tiles: Tienda
-------------------------
VENDEDOR/A: ¬øEn qu√© puedo ayudarle?
T√ö: Busco...
T√ö: ¬øCu√°nto cuesta?
T√ö: ¬øTiene en otra talla/color?

Para pagar:
- ¬øAceptan tarjetas?
- ¬øPuedo pagar con m√≥vil?
- ¬øD√≥nde est√° el probador?

Despedida:
- Gracias
- Adi√≥s
- Hasta luego`,

      'Pedir direcciones': `Frases √∫tiles: Direcciones
----------------------------
PERO: Disculpe, ¬øpor favor... ¬ød√≥nde est√° [lugar]?
LOCAL: Siga todo recto y gire a la derecha/izquierda.

Preguntas comunes:
- ¬øC√≥mo llego a...?
- ¬øEst√° lejos?
- ¬øHay una parada de metro cerca?
- ¬øD√≥nde est√° el ba√±o?

Respuestas √∫tiles:
- Est√° a cinco minutos andando
- Tenga que coger el autob√∫s n√∫mero 12
- No, est√° muy cerca`
    };

    document.getElementById('plantilla')?.addEventListener('click', () => {
      const actividad = document.getElementById('obra').value;
      const plantilla = PLANTILLAS[actividad];
      if (plantilla) {
        document.getElementById('guion').value = plantilla;
      }
    });

    document.getElementById('limpiar')?.addEventListener('click', () => {
      document.getElementById('titulo').value = '';
      document.getElementById('guion').value = '';
    });

    document.getElementById('guardar')?.addEventListener('click', () => {
      const actividad = document.getElementById('obra').value;
      const titulo = document.getElementById('titulo').value || 'pr√°ctica';
      const guion = document.getElementById('guion').value;

      const texto = `${actividad}: ${titulo}\n${'='.repeat(50)}\n\n${guion}\n\n---\nGenerado en Curso Intensivo de Espa√±ol - Nivel 3 CLM`;

      const blob = new Blob([texto], { type: 'text/plain;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${actividad.replace(/\s+/g, '_')}_${titulo.replace(/\s+/g, '_')}.txt`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });

    updateCurrentDate();
    initQRSystem();
    renderGuiasS1();
    renderMaterialesCurso();

    // Verificar acceso de profesor para Hoja de Asistencia
    const urlParams = new URLSearchParams(window.location.search);
    const profesorAccess = urlParams.get('profesor') || urlParams.get('profesor_access') || urlParams.get('admin');

    if (profesorAccess === '1' || profesorAccess === 'true' || profesorAccess === 'javier2025') {
      const profesorSection = document.getElementById('profesor-only');
      if (profesorSection) {
        profesorSection.style.display = 'block';
      }
    }

    // Interactive Learning Features
    const conversationDialogs = {
      restaurant: {
        title: "En el Restaurante",
        dialog: [
          { speaker: "Camarero", text: "Buenas tardes. ¬øQu√© van a tomar?" },
          { speaker: "Cliente", text: "Hola. Me gustar√≠a ver el men√∫, por favor." },
          { speaker: "Camarero", text: "Claro. ¬øDesean algo de beber?" },
          { speaker: "Cliente", text: "S√≠, una cerveza y un agua." },
          { speaker: "Camarero", text: "Perfecto. ¬øYa decidieron qu√© van a comer?" },
          { speaker: "Cliente", text: "S√≠, quiero la paella valenciana." },
          { speaker: "Camarero", text: "Excelente elecci√≥n. Enseguida lo traigo." }
        ]
      },
      directions: {
        title: "Pidiendo Direcciones",
        dialog: [
          { speaker: "Turista", text: "Disculpe. ¬øPodr√≠a ayudarme?" },
          { speaker: "Local", text: "Claro que s√≠. ¬øQu√© necesita?" },
          { speaker: "Turista", text: "Busco la catedral. ¬øSabe c√≥mo llegar?" },
          { speaker: "Local", text: "S√≠. Siga toda esta calle recta." },
          { speaker: "Turista", text: "¬øRecto hasta el final?" },
          { speaker: "Local", text: "S√≠, al final gire a la derecha. Est√° a unos 10 minutos." },
          { speaker: "Turista", text: "Muchas gracias por su ayuda." }
        ]
      },
      shopping: {
        title: "En la Tienda de Ropa",
        dialog: [
          { speaker: "Vendedor", text: "Buenos d√≠as. ¬øBusca algo en especial?" },
          { speaker: "Cliente", text: "S√≠, busco una chaqueta." },
          { speaker: "Vendedor", text: "¬øQu√© talla necesita?" },
          { speaker: "Cliente", text: "Talla mediana, por favor." },
          { speaker: "Vendedor", text: "Qu√© tal esta. Es de cuero y muy resistente." },
          { speaker: "Cliente", text: "Me gusta. ¬øCu√°nto cuesta?" },
          { speaker: "Vendedor", text: "Son 89 euros." }
        ]
      },
      pharmacy: {
        title: "En la Farmacia",
        dialog: [
          { speaker: "Cliente", text: "Buenos d√≠as. Tengo dolor de cabeza." },
          { speaker: "Farmac√©utico", text: "¬øDesde cu√°ndo tiene dolor?" },
          { speaker: "Cliente", text: "Desde esta ma√±ana." },
          { speaker: "Farmac√©utico", text: "Le recomiendo ibuprofeno." },
          { speaker: "Cliente", text: "¬øTengo que tomarlo con comida?" },
          { speaker: "Farmac√©utico", text: "S√≠, es mejor tomarlo despu√©s de comer." },
          { speaker: "Cliente", text: "Perfecto. ¬øCu√°nto cuesta?" }
        ]
      },
      hotel: {
        title: "En el Hotel",
        dialog: [
          { speaker: "Recepcionista", text: "Buenos d√≠as. Bienvenido a nuestro hotel." },
          { speaker: "Hu√©sped", text: "Hola. Tengo una reserva a nombre de Garc√≠a." },
          { speaker: "Recepcionista", text: "D√©jeme buscar... S√≠, habitaci√≥n 305." },
          { speaker: "Hu√©sped", text: "¬øA qu√© hora sirve el desayuno?" },
          { speaker: "Recepcionista", text: "El desayuno se sirve de 7 a 10:30." },
          { speaker: "Hu√©sped", text: "¬øHay wifi en las habitaciones?" },
          { speaker: "Recepcionista", text: "S√≠, es gratis y la contrase√±a est√° en la llave." }
        ]
      },
      transport: {
        title: "Transporte P√∫blico",
        dialog: [
          { speaker: "Pasajero", text: "Disculpe. ¬øEste autob√∫s va al centro?" },
          { speaker: "Conductor", text: "S√≠. Este autob√∫s va directamente al centro." },
          { speaker: "Pasajero", text: "¬øCu√°nto cuesta el billete?" },
          { speaker: "Conductor", text: "Son 1.40 euros." },
          { speaker: "Pasajero", text: "¬øTiene que hacer transbordo?" },
          { speaker: "Conductor", text: "No. Directo al centro en unos 20 minutos." },
          { speaker: "Pasajero", text: "Muchas gracias." }
        ]
      }
    };

    // Game system variables
    let userPoints = 0;
    let currentGrammarExercise = 1;

    // Conversation functions
    function showDialog(scenario) {
      const dialog = conversationDialogs[scenario];
      if (!dialog) return;

      let dialogHTML = `
        <div style="padding: 1.5rem; max-width: 500px; margin: 0 auto;">
          <h3 style="color: var(--brand); margin-bottom: 1rem;">${dialog.title}</h3>
      `;

      dialog.dialog.forEach((line, index) => {
        const speakerColor = line.speaker.includes('Cliente') || line.speaker.includes('Turista') ||
                            line.speaker.includes('Pasajero') || line.speaker.includes('Hu√©sped') ? '#059669' : '#3b82f6';

        dialogHTML += `
          <div style="margin: 1rem 0; padding: 0.8rem; background: ${index % 2 === 0 ? '#f0f9ff' : '#f0fdf4'}; border-radius: 0.5rem; border-left: 4px solid ${speakerColor};">
            <strong style="color: ${speakerColor};">${line.speaker}:</strong> ${line.text}
          </div>
        `;
      });

      dialogHTML += `
          <div style="text-align: center; margin-top: 1.5rem;">
            <button class="btn primary" onclick="closeDialog()">Cerrar</button>
            <button class="btn" onclick="practiceDialog('${scenario}')">Practicar</button>
          </div>
        </div>
      `;

      showModalDialog(dialog.title, dialogHTML);
    }

    function showModalDialog(title, content) {
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 1000;
      `;
      modal.innerHTML = `
        <div style="background: white; border-radius: 1rem; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; padding: 0;">
          <div style="padding: 1rem 1.5rem; background: var(--brand); color: white; border-radius: 1rem 1rem 0 0; display: flex; justify-content: space-between; align-items: center;">
            <h3 style="margin: 0;">${title}</h3>
            <button onclick="this.closest('.modal-overlay').remove()" style="background: white; color: var(--brand); border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; font-size: 1.2rem;">√ó</button>
          </div>
          <div>${content}</div>
        </div>
      `;
      modal.className = 'modal-overlay';
      document.body.appendChild(modal);

      modal.addEventListener('click', function(e) {
        if (e.target === modal) {
          modal.remove();
        }
      });
    }

    function closeDialog() {
      document.querySelector('.modal-overlay')?.remove();
    }

    function practiceDialog(scenario) {
      showNotification('üé§ Modo pr√°ctica iniciado. Graba tu voz y compara con el original.', 'success');
      userPoints += 5;
      updateUserPoints();
      closeDialog();
    }

    function downloadConversationGuide() {
      showNotification('üìÑ Descargando gu√≠a completa de conversaci√≥n...', 'success');
      window.open('materials/conversaciones-practicas.pdf', '_blank');
      userPoints += 3;
      updateUserPoints();
    }

    function startConversationPractice() {
      showNotification('üé§ Iniciando sesi√≥n de pr√°ctica guiada...', 'success');
      userPoints += 2;
      updateUserPoints();
    }

    // Grammar exercises functions
    function checkGrammarAnswer(exerciseId, correctAnswer) {
      const userAnswer = document.getElementById(`grammar${exerciseId}`).value.trim().toLowerCase();

      if (userAnswer === correctAnswer.toLowerCase()) {
        showNotification('‚úÖ ¬°Correcto! Bien hecho.', 'success');
        userPoints += 2;
        updateUserPoints();
        document.getElementById(`grammar${exerciseId}`).style.borderColor = '#059669';
        document.getElementById(`grammar${exerciseId}`).style.backgroundColor = '#dcfce7';
      } else {
        showNotification(`‚ùå Incorrecto. La respuesta correcta es: ${correctAnswer}`, 'error');
        document.getElementById(`grammar${exerciseId}`).style.borderColor = '#ef4444';
        document.getElementById(`grammar${exerciseId}`).style.backgroundColor = '#fee2e2';
      }
    }

    function loadNewGrammarExercises() {
      const exercises = [
        { question: "Ella _____ profesora de espa√±ol. (ser/estar)", answer: "es" },
        { question: "Los libros _____ sobre la mesa. (ser/estar)", answer: "est√°n" },
        { question: "Nosotros _____ al parque todos los d√≠as. (ir)", answer: "vamos" },
        { question: "T√∫ _____ muy inteligente. (ser/estar)", answer: "eres" }
      ];

      const randomExercise = exercises[Math.floor(Math.random() * exercises.length)];
      showNotification(`üîÑ Nuevo ejercicio cargado: ${randomExercise.question}`, 'success');
      userPoints += 1;
      updateUserPoints();
    }

    function showGrammarSolutions() {
      const solutions = `
        <h4>Soluciones:</h4>
        <ul>
          <li><strong>soy</strong> - Yo soy estudiante (identidad permanente)</li>
          <li><strong>est√°</strong> - La clase est√° interesante (estado temporal)</li>
          <li><strong>tengo</strong> - Tener: posesi√≥n</li>
          <li><strong>haces</strong> - T√∫: forma de hacer</li>
        </ul>
      `;
      showModalDialog('Soluciones de Gram√°tica', `<div style="padding: 1.5rem;">${solutions}</div>`);
      userPoints += 1;
      updateUserPoints();
    }

    // Points system functions
    function updateUserPoints() {
      const pointsElement = document.getElementById('userPoints');
      if (pointsElement) {
        pointsElement.textContent = userPoints;
      }

      // Check for milestones
      if (userPoints >= 100 && userPoints < 103) {
        showNotification('üéâ ¬°Felicidades! Has alcanzado 100 puntos.', 'success');
      } else if (userPoints >= 50 && userPoints < 53) {
        showNotification('üåü ¬°Excelente! Has alcanzado 50 puntos.', 'success');
      }

      // Update main progress
      updateMainProgress();
    }

    function showNotification(message, type) {
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 1rem 1.5rem;
        border-radius: 0.5rem;
        color: white;
        font-weight: 600;
        z-index: 1000;
        animation: slideIn 0.3s ease;
        background: ${type === 'success' ? '#059669' : '#ef4444'};
      `;
      notification.textContent = message;

      document.body.appendChild(notification);

      setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => notification.remove(), 300);
      }, 2000);
    }

    // Progress tracking functions
    function updateMainProgress() {
      let totalProgress = 0;
      let totalItems = 4;

      // Calculate attendance progress (simulated)
      const attendanceProgress = 8; // out of 16 classes (Lunes-Jueves x 4 semanas)
      totalProgress += (attendanceProgress / 16) * 100;

      // Calculate materials progress (simulated)
      const materialsProgress = 5; // out of 8
      totalProgress += (materialsProgress / 8) * 100;

      // Calculate projects progress (simulated)
      const projectsProgress = 1; // out of 3
      totalProgress += (projectsProgress / 3) * 100;

      // Calculate points progress (max 100 points for completion)
      const pointsProgress = Math.min(userPoints, 100);
      totalProgress += (pointsProgress / 100) * 100;

      const overallProgress = Math.round(totalProgress / totalItems);

      const progressBar = document.getElementById('mainProgress');
      const progressText = document.getElementById('progressText');

      if (progressBar) {
        progressBar.style.width = overallProgress + '%';
      }

      if (progressText) {
        progressText.textContent = `${overallProgress}% completado - ¬°Sigue as√≠!`;
      }
    }

    function updateWeeklyProgress() {
      const goals = document.querySelectorAll('#weeklyGoals input[type="checkbox"]');
      const checked = document.querySelectorAll('#weeklyGoals input[type="checkbox"]:checked');
      const percentage = Math.round((checked.length / goals.length) * 100);

      const progressBar = document.getElementById('weeklyProgress');
      const progressText = document.getElementById('weeklyProgressText');

      if (progressBar) {
        progressBar.style.width = percentage + '%';
      }

      if (progressText) {
        progressText.textContent = `${percentage}% de los objetivos semanales completados`;
      }
    }

    // Quick tools functions
    function openQuickTools() {
      const modal = document.getElementById('quickTools');
      if (modal) {
        modal.classList.add('show');
      }
    }

    function closeQuickTools(event) {
      if (!event || event.target.id === 'quickTools') {
        const modal = document.getElementById('quickTools');
        if (modal) {
          modal.classList.remove('show');
        }
      }
    }

    function startVocabularyTimer() {
      closeQuickTools();
      const minutes = 5;
      let seconds = minutes * 60;

      const timerDiv = document.createElement('div');
      timerDiv.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: var(--brand);
        color: white;
        padding: 2rem;
        border-radius: 1rem;
        font-size: 2rem;
        font-weight: bold;
        z-index: 1000;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      `;

      document.body.appendChild(timerDiv);

      const interval = setInterval(() => {
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        timerDiv.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;

        if (seconds === 0) {
          clearInterval(interval);
          timerDiv.textContent = '¬°Tiempo completado!';
          setTimeout(() => timerDiv.remove(), 2000);
        }

        seconds--;
      }, 1000);
    }

    function openPronunciationGuide() {
      closeQuickTools();
      showNotification('üó£Ô∏è Gu√≠a de pronunciaci√≥n pr√≥ximamente', 'success');
    }

    // Student authentication system
    let currentUser = null;

    function showRegisterForm() {
      document.getElementById('loginForm').style.display = 'none';
      document.getElementById('registerForm').style.display = 'block';
    }

    function showLoginForm() {
      document.getElementById('registerForm').style.display = 'none';
      document.getElementById('loginForm').style.display = 'block';
    }

    async function studentRegister() {
      const name = document.getElementById('regName').value.trim();
      const email = document.getElementById('regEmail').value.trim();
      const studentId = document.getElementById('regStudentId').value.trim();

      if (!name || !email) {
        showNotification('‚ùå Por favor completa todos los campos obligatorios', 'error');
        return;
      }

      // Validaci√≥n b√°sica de email
      if (!email.includes('@') || !email.includes('.')) {
        showNotification('‚ùå Por favor ingresa un email v√°lido', 'error');
        return;
      }

      try {
        const response = await fetch('http://localhost:5000/api/register', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            name: name,
            email: email,
            student_id: studentId || null
          })
        });

        const data = await response.json();

        if (data.success) {
          showNotification(`‚úÖ ¬°Registro exitoso! Tu ID: ${data.user.id}`, 'success');
          showLoginCredentials(data.user);

          // Mostrar las credenciales y luego cambiar a login
          setTimeout(() => {
            document.getElementById('studentId').value = data.user.id;
            document.getElementById('studentPassword').value = data.user.password;
            showLoginForm();
          }, 3000);
        } else {
          showNotification(`‚ùå Error: ${data.error}`, 'error');
        }
      } catch (error) {
        showNotification('‚ö†Ô∏è Error de conexi√≥n. Por favor intenta m√°s tarde.', 'error');
        console.error('Registration error:', error);
      }
    }

    function showLoginCredentials(user) {
      const credentialsHTML = `
        <div style="background: #f0f9ff; border: 2px solid #3b82f6; border-radius: 0.5rem; padding: 1rem; margin: 1rem 0;">
          <h4 style="color: #1e40af; margin: 0 0 0.5rem 0;">üéâ ¬°Cuenta Creada!</h4>
          <p style="margin: 0.5rem 0;"><strong>ID de Estudiante:</strong> ${user.id}</p>
          <p style="margin: 0.5rem 0;"><strong>Contrase√±a:</strong> ${user.password}</p>
          <p style="margin: 0.5rem 0; color: #6b7280; font-size: 0.9rem;">üìù ¬°Guarda estas credenciales! Necesitar√°s tu ID y contrase√±a para iniciar sesi√≥n.</p>
        </div>
      `;

      // Insertar despu√©s del bot√≥n de registro
      const registerBtn = document.querySelector('#registerForm button');
      registerBtn.insertAdjacentHTML('afterend', credentialsHTML);
    }

    async function studentLogin() {
      const studentId = document.getElementById('studentId').value.trim();
      const password = document.getElementById('studentPassword').value;

      if (!studentId || !password) {
        showNotification('‚ùå Por favor completa todos los campos', 'error');
        return;
      }

      try {
        const response = await fetch('http://localhost:5000/api/login', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            user_id: studentId,
            password: password
          })
        });

        const data = await response.json();

        if (data.success) {
          currentUser = data.user;
          localStorage.setItem('currentUser', JSON.stringify(currentUser));
          showNotification(`‚úÖ ¬°Bienvenido ${currentUser.name}!`, 'success');
          showUserProfile();
          loadUserProgress();
        } else {
          showNotification(`‚ùå Error: ${data.error}`, 'error');
        }
      } catch (error) {
        showNotification('‚ö†Ô∏è Error de conexi√≥n. Inicia el servidor de Python primero.', 'error');
        console.error('Login error:', error);
      }
    }

    function showUserProfile() {
      // Ocultar formularios de login
      document.getElementById('loginForm').style.display = 'none';
      document.getElementById('registerForm').style.display = 'none';

      // Mostrar informaci√≥n del usuario
      document.getElementById('userInfo').style.display = 'block';

      // Actualizar mensaje de bienvenida
      document.getElementById('welcomeMessage').textContent = `¬°Bienvenido, ${currentUser.name}!`;
      document.getElementById('userDetails').innerHTML = `
        Estudiante del Curso Intensivo de Espa√±ol<br>
        <small style="color: #6b7280;">ID: ${currentUser.id}</small>
      `;

      // Hacer visible toda la secci√≥n de progreso
      document.getElementById('loginSection').style.display = 'none';
      document.getElementById('progressSection').style.display = 'block';
    }

    function studentLogout() {
      currentUser = null;
      localStorage.removeItem('currentUser');

      // Ocultar informaci√≥n de usuario
      document.getElementById('userInfo').style.display = 'none';
      document.getElementById('progressSection').style.display = 'none';

      // Mostrar formulario de login
      document.getElementById('loginForm').style.display = 'block';
      document.getElementById('loginSection').style.display = 'block';

      // Limpiar campos
      document.getElementById('studentId').value = '';
      document.getElementById('studentPassword').value = '';

      showNotification('üëã Sesi√≥n cerrada correctamente', 'success');
    }

    async function loadUserProgress() {
      if (!currentUser) return;

      try {
        const response = await fetch(`http://localhost:5000/api/progress/${currentUser.id}`);
        const data = await response.json();

        if (data.success) {
          const progress = data.progress;

          // Actualizar progreso en la interfaz
          updateProgressDisplay(progress);

          // Actualizar puntos del usuario
          userPoints = progress.quiz_scores?.total_quizzes * 2 || 0;
          updateUserPoints();
        }
      } catch (error) {
        console.error('Error loading user progress:', error);
        // Cargar progreso simulado si el servidor no est√° disponible
        loadSimulatedProgress();
      }
    }

    function updateProgressDisplay(progress) {
      // Actualizar attendance
      const attendanceEl = document.getElementById('userAttendanceProgress');
      if (attendanceEl) {
        attendanceEl.textContent = `${progress.attendance?.attended_classes || 0}/16`;
      }

      // Actualizar materiales
      const materialsEl = document.getElementById('userMaterialsProgress');
      if (materialsEl) {
        materialsEl.textContent = `${progress.materials?.exercises_completed || 0}/8`;
      }
    }

    function loadSimulatedProgress() {
      // Progreso simulado cuando el servidor no est√° disponible
      const simulatedProgress = {
        attendance: { attended_classes: 3, total_classes: 16 },
        materials: { exercises_completed: 2, total_exercises: 8 }
      };
      updateProgressDisplay(simulatedProgress);
    }

    function saveProgressToServer(type, data) {
      if (!currentUser) return;

      const endpoints = {
        'attendance': '/api/attendance',
        'quiz': '/api/quiz',
        'materials': '/api/materials',
        'projects': '/api/projects'
      };

      fetch(`http://localhost:5000${endpoints[type]}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          user_id: currentUser.id,
          ...data
        })
      }).catch(error => {
        console.error('Error saving progress:', error);
      });
    }

    // Initialize everything when DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
      // Check if user is already logged in
      const savedUser = localStorage.getItem('currentUser');
      if (savedUser) {
        try {
          currentUser = JSON.parse(savedUser);
          showUserProfile();
          loadUserProgress();
        } catch (error) {
          localStorage.removeItem('currentUser');
        }
      }

      // Update general progress
      updateMainProgress();
      updateWeeklyProgress();
      updateUserPoints();
    });

    // Add CSS animations
    const style = document.createElement('style');
    style.textContent = `
      @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }
      @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
      }
    `;
    document.head.appendChild(style);
  </script>

  <!-- Floating Action Button -->
  <div class="fab" onclick="openQuickTools()" title="Herramientas R√°pidas">
    ‚ö°
  </div>

  <!-- Quick Tools Modal -->
  <div id="quickTools" class="overlay" onclick="closeQuickTools(event)">
    <div class="viewer" style="inset: 10% 20%; max-width: 600px; margin: auto;" onclick="event.stopPropagation()">
      <div class="top">
        <span>Herramientas de Aprendizaje R√°pido</span>
        <div class="spacer"></div>
        <button class="btn" onclick="closeQuickTools()">‚úï</button>
      </div>
      <div class="content" style="padding: 1.5rem; text-align: center;">
        <h3 style="color: var(--brand); margin-bottom: 1.5rem;">üöÄ Acceso R√°pido</h3>

        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
          <button class="btn primary" style="padding: 1rem; font-size: 1.1rem;" onclick="window.open('#s2', '_self')">
            üéØ Competencias
          </button>
          <button class="btn primary" style="padding: 1rem; font-size: 1.1rem;" onclick="window.open('#s3', '_self')">
            üìö Temario
          </button>
          <button class="btn primary" style="padding: 1rem; font-size: 1.1rem;" onclick="window.open('#s5', '_self')">
            üìù Evaluaci√≥n
          </button>
          <button class="btn primary" style="padding: 1rem; font-size: 1.1rem;" onclick="window.open('#descargas', '_self')">
            üìÇ Descargas
          </button>
        </div>

        <h4 style="color: var(--secondary-color); margin-bottom: 1rem;">üéµ Recursos de Audio</h4>
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
          <button class="btn" style="padding: 0.8rem;" onclick="alert('Pr√≥ximamente: Audiopr√°cticas')">
            üéß Audiopr√°cticas
          </button>
          <button class="btn" style="padding: 0.8rem;" onclick="alert('Pr√≥ximamente: Pronunciaci√≥n')">
            üîä Pronunciaci√≥n
          </button>
          <button class="btn" style="padding: 0.8rem;" onclick="startVocabularyTimer()">
            ‚è±Ô∏è Temporizador Vocab
          </button>
          <button class="btn" style="padding: 0.8rem;" onclick="openPronunciationGuide()">
            üó£Ô∏è Gu√≠a Pronunciaci√≥n
          </button>
        </div>

        <div style="padding: 1rem; background: var(--s1); border-radius: 0.5rem; margin-top: 1rem;">
          <p style="margin: 0; color: #92400e;">
            <strong>üí° Tip del d√≠a:</strong> Practica espa√±ol 15 minutos diarios para mejores resultados.
          </p>
        </div>
      </div>
    </div>
  </div>

</body>
</html>
